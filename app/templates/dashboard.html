<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œå°</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

<!-- Mobile Header -->
<header class="mobile-header">
    <button class="menu-toggle" id="menu-toggle">â˜°</button>
    <h2>AI å•è¯æœ¬</h2>
</header>

<div class="app-layout">
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>AI Word Notebook</h2>
        </div>
        
        <div class="user-info">
            {{ user.email }}
        </div>

        <nav class="nav-links">
            <button class="nav-btn active" onclick="switchTab('vocab')">
                ğŸ“š å•è¯ç®¡ç†
            </button>
            <button class="nav-btn" onclick="switchTab('review')">
                ğŸ§  å•è¯å¤ä¹ 
            </button>
            {% if user.is_admin %}
            <a href="/admin/dashboard" class="nav-btn">
                âš™ï¸ åå°ç®¡ç†
            </a>
            {% endif %}
        </nav>

        <div class="sidebar-footer">
            <button class="nav-btn" onclick="logout()">
                ğŸšª é€€å‡ºç™»å½•
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Tab: Vocabulary Management -->
        <div id="tab-vocab" class="tab-pane active">
            <section class="panel">
                <h2>æ·»åŠ å•è¯</h2>
                <form id="add-word-form">
                    <div class="grid">
                        <label>è‹±æ–‡
                            <input name="english" placeholder="hello">
                        </label>
                        <label>ä¸­æ–‡
                            <input name="chinese" placeholder="ä½ å¥½">
                        </label>
                        <label>è¯æ€§
                            <input name="part_of_speech" placeholder="noun">
                        </label>
                    </div>
                    <label>å®šä¹‰
                        <textarea name="definition" placeholder="greeting used when meeting"></textarea>
                    </label>
                    <label>ä¾‹å¥
                        <textarea name="examples" placeholder="Hello, world!"></textarea>
                    </label>
                    <div class="actions">
                        <button class="btn" type="button" id="ai-complete">AI è¡¥å…¨</button>
                        <button class="btn ghost" type="submit">ä¿å­˜</button>
                    </div>
                    <pre id="completion-output" style="display: none;"></pre>
                </form>
            </section>

            <section class="panel">
                <h2>æˆ‘çš„å•è¯</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>è¯æ€§</th>
                            <th>å®šä¹‰</th>
                            <th>ä¾‹å¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for word in words %}
                            <tr data-id="{{ word.id }}" data-examples="{{ word.examples }}">
                                <td>{{ word.english }}</td>
                                <td>{{ word.chinese }}</td>
                                <td>{{ word.part_of_speech }}</td>
                                <td>{{ word.definition }}</td>
                                <td>
                                    {% if word.examples %}
                                    <button class="btn ghost small example-btn" onclick="showExamples(this)">
                                        <span class="text-desktop">æŸ¥çœ‹</span>
                                        <span class="text-mobile">æŸ¥çœ‹ä¾‹å¥</span>
                                    </button>
                                    <div class="hidden examples-data">{{ word.examples }}</div>
                                    {% else %}
                                    <span style="color: var(--muted);">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="btn small" onclick="editWord({{ word.id }})">ç¼–è¾‘</button>
                                        <button class="btn danger small" onclick="deleteWord({{ word.id }})">åˆ é™¤</button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Tab: Review -->
        <div id="tab-review" class="tab-pane">
            <section class="panel">
                <h2>èƒŒå•è¯</h2>
                <form id="start-review">
                    <label>æ¨¡å¼
                        <select name="mode">
                            <option value="en_to_zh">è‹± â†’ ä¸­</option>
                            <option value="zh_to_en">ä¸­ â†’ è‹±</option>
                        </select>
                    </label>
                    <label>æ•°é‡
                        <input name="count" type="number" value="5" min="1" max="30">
                    </label>
                    <button class="btn" type="submit">å¼€å§‹</button>
                </form>
                <div id="review-area"></div>
            </section>
        </div>

    </main>
</div>

<!-- Example Modal -->
<div class="modal-overlay" id="example-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>ä¾‹å¥</h3>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="modal-content"></div>
    </div>
</div>

<script src="/static/app.js"></script>
<script>
    // Modal Logic
    const modal = document.getElementById('example-modal');
    const modalContent = document.getElementById('modal-content');

    function showExamples(btn) {
        // Find the hidden div next to the button
        const content = btn.nextElementSibling.textContent;
        // Try to parse if it's JSON, otherwise show text
        try {
            const jsonContent = JSON.parse(content);
            let html = "";
            jsonContent.forEach(ex => {
                html += `<p><strong>${ex.sentenceEn}</strong><br><span style="color:var(--muted)">${ex.sentenceZh}</span></p><hr style="border:0; border-top:1px dashed var(--border); margin:1rem 0;">`;
            });
            modalContent.innerHTML = html;
        } catch (e) {
            modalContent.textContent = content;
        }
        
        modal.classList.add('active');
    }

    function closeModal() {
        modal.classList.remove('active');
    }

    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // Tab Switching Logic
    function switchTab(tabId) {
        // Update Buttons
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = event.currentTarget;
        if(activeBtn.tagName === 'BUTTON') activeBtn.classList.add('active');

        // Update Panes
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');

        // Close sidebar on mobile
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('active');
        }
    }

    // Mobile Sidebar Logic
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    if(menuToggle) {
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });
    }

    if(overlay) {
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });
    }

    // Logout Logic
    function logout() {
        document.cookie = 'access_token=; Max-Age=0; path=/';
        localStorage.removeItem('token');
        window.location.href = '/';
    }

    // Delete Word Logic
    async function deleteWord(id) {
        if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
        const token = localStorage.getItem("token");
        await fetch(`/words/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` }
        });
        location.reload();
    }
</script>
</body>
</html>